{% extends "base.html" %}
{% block title %}{{ tr['settings_title'] if tr else 'Settings' }} - {{ tr['app_name'] if tr else 'CaptureLapse' }}{%
endblock %}
{% block content %}
<h2><i class="fa-solid fa-gear me-2"></i>{{ tr['settings_title'] if tr else 'Settings' }}</h2>
<hr class="mx-auto">
<form id="settings-form" method="post" action="/update" class="mt-3"
      data-save-success="{{ tr.get('settings_saved', 'Einstellungen gespeichert') if tr else 'Einstellungen gespeichert' }}"
      data-save-error="{{ tr.get('settings_save_failed', 'Speichern fehlgeschlagen') if tr else 'Speichern fehlgeschlagen' }}"
      data-geo-success="{{ tr.get('geo_success', 'Koordinaten aus Browserstandort übernommen') if tr else 'Koordinaten aus Browserstandort übernommen' }}"
      data-geo-unsupported="{{ tr.get('geo_unsupported', 'Browser-Geolokalisierung wird nicht unterstützt') if tr else 'Browser-Geolokalisierung wird nicht unterstützt' }}"
      data-geo-denied="{{ tr.get('geo_denied', 'Standortfreigabe verweigert') if tr else 'Standortfreigabe verweigert' }}"
      data-geo-error="{{ tr.get('geo_error', 'Standort konnte nicht ermittelt werden') if tr else 'Standort konnte nicht ermittelt werden' }}"
      data-validate-date-range="{{ tr.get('validation_date_range', 'Start date must not be after end date') if tr else 'Start date must not be after end date' }}"
      data-validate-cam-url="{{ tr.get('validation_cam_url', 'Snapshot URL is required') if tr else 'Snapshot URL is required' }}"
      data-validate-interval="{{ tr.get('validation_interval', 'Interval must be a positive number') if tr else 'Interval must be a positive number' }}"
      data-validate-auth-username="{{ tr.get('validation_auth_username', 'Username is required for authentication') if tr else 'Username is required for authentication' }}"
      data-validate-auth-password="{{ tr.get('validation_auth_password', 'Password is required for authentication') if tr else 'Password is required for authentication' }}"
      data-validate-lat-required="{{ tr.get('validation_lat_required', 'Latitude is required when Astral is enabled') if tr else 'Latitude is required when Astral is enabled' }}"
      data-validate-lon-required="{{ tr.get('validation_lon_required', 'Longitude is required when Astral is enabled') if tr else 'Longitude is required when Astral is enabled' }}"
      data-validate-lat-range="{{ tr.get('validation_lat_range', 'Latitude must be between -90 and 90') if tr else 'Latitude must be between -90 and 90' }}"
      data-validate-lon-range="{{ tr.get('validation_lon_range', 'Longitude must be between -180 and 180') if tr else 'Longitude must be between -180 and 180' }}">
  <input type="hidden" name="ORIGINAL_LANGUAGE" value="{{ lang or 'de' }}">
  <!-- Main -->
  <h5 class="mb-2">{{ tr["main"] if tr else "Main" }}</h5>
  <div class="row g-3 mb-3">
    <div class="col-md-5">
      <label class="form-label">{{ tr["instance_name"] if tr else "Instance Name" }}</label>
      <input class="form-control" name="INSTANCE_NAME" value="{{ cfg.instance_name or '' }}" maxlength="80">
    </div>
    <div class="col-md-2 offset-md-1">
      <label class="form-label">{{ tr['language'] if tr else 'Sprache' }}</label>
      <select class="form-select" name="LANGUAGE">
        {% for code in (langs or []) %}
        <option value="{{ code }}" {% if (lang or 'de' )==code %}selected{% endif %}>{{ tr.get(code, code) if tr else
          code }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="row g-3 mb-3">
    <div class="col-md-5">
      <label class="form-label">{{ tr.get("access_password", "Access Password") if tr else "Access Password" }}</label>
      {% set access_password_set = ((cfg.access_password_hash if cfg.access_password_hash is defined else None) or (cfg.access_password or '')) %}
      <input type="password" class="form-control" name="ACCESS_PASSWORD" value="">
      <div class="form-text">{{ tr.get("access_password_help", "Leave empty to keep current password") if tr else "Leave empty to keep current password" }}</div>
      <div class="form-text">{{ tr.get("access_password_note", "The current password is not shown for security reasons") if tr else "The current password is not shown for security reasons" }}</div>
      {% if not access_password_set %}
      <div class="form-text">{{ tr.get("access_password_not_set", "No access password is set") if tr else "No access password is set" }}</div>
      {% endif %}
      <div class="form-check form-switch mt-2">
        <input
          class="form-check-input"
          type="checkbox"
          id="access-password-enable"
          name="ACCESS_PASSWORD_ENABLE"
          value="true"
          {% if access_password_set %}checked{% endif %}
        >
        <label class="form-check-label" for="access-password-enable">{{ tr.get("access_password_enable", "Enable login protection") if tr else "Enable login protection" }}</label>
      </div>
    </div>
  </div>
  <hr class="mx-auto">
  <!-- Camera settings -->
  <h5 class="mb-2"><i class="fa-solid fa-camera me-2"></i>{{ tr["camera"] if tr else "Camera" }}</h5>
  <div class="row g-3 mb-3">
    <div class="col-md-10">
      <label class="form-label">{{ tr["snapshot_url"] if tr else "Snapshot URL" }}</label>
      <input class="form-control" name="CAM_URL" value="{{ cfg.cam_url }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">{{ tr["interval_seconds"] if tr else "Interval (sec)" }}</label>
      <input type="number" min="1" class="form-control" name="INTERVAL_SECONDS" value="{{ cfg.interval_seconds }}">
    </div>
    <div class="col-md-3" style="display:none;">
      <label class="form-label">{{ tr["save_path"] if tr else "Save Path" }}</label>
      <input class="form-control" name="SAVE_PATH" value="{{ cfg.save_path }}">
    </div>
  </div>
  <hr class="mx-auto">
  <!-- Authentication -->
  <h5 class="mb-2"><i class="fa-solid fa-lock me-2"></i>{{ tr["auth"] if tr else "Authentication" }}</h5>
  <div class="row g-3 mb-3">
    <div class="col-md-2">
      <label class="form-label">{{ tr["auth_type"] if tr else "Auth Type" }}</label>
      <select class="form-select" name="AUTH_TYPE">
        <option value="none" {% if cfg.auth_type=="none" %}selected{% endif %}>{{ tr["none"] if tr else "None" }}
        </option>
        <option value="basic" {% if cfg.auth_type=="basic" %}selected{% endif %}>{{ tr["basic"] if tr else "HTTP Basic"
          }}</option>
        <option value="digest" {% if cfg.auth_type=="digest" %}selected{% endif %}>{{ tr["digest"] if tr else "HTTP
          Digest" }}</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">{{ tr["username"] if tr else "Username" }}</label>
      <input class="form-control" name="USERNAME" value="{{ cfg.username or '' }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">{{ tr["password"] if tr else "Password" }}</label>
      <input type="password" class="form-control" name="PASSWORD" value="{{ cfg.password or '' }}">
    </div>
  </div>
  <hr class="mx-auto">
  <!-- Time control -->
  <h5 class="mb-2"><i class="fa-solid fa-clock me-2"></i>{{ tr["time_control"] if tr else "Time Control" }}</h5>
  <div class="row g-3 mb-3">
    <div class="col-md-2">
      <label class="form-label">{{ tr["start_time"] if tr else "Start Time" }}</label>
      <input type="time" class="form-control" name="ACTIVE_START" value="{{ cfg.active_start }}"
        pattern="[0-9]{2}:[0-9]{2}" step="60" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">{{ tr["end_time"] if tr else "End Time" }}</label>
      <input type="time" class="form-control" name="ACTIVE_END" value="{{ cfg.active_end }}"
        pattern="[0-9]{2}:[0-9]{2}" step="60" required>
    </div>
    <div class="col-12">
      <label class="form-label d-block">{{ tr["weekdays"] if tr else "Weekdays" }}</label>
      <div class="d-flex flex-wrap gap-3 align-items-center">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Mon" name="ACTIVE_DAYS" value="Mon" {% if 'Mon' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Mon">Mo</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Tue" name="ACTIVE_DAYS" value="Tue" {% if 'Tue' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Tue">Di</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Wed" name="ACTIVE_DAYS" value="Wed" {% if 'Wed' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Wed">Mi</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Thu" name="ACTIVE_DAYS" value="Thu" {% if 'Thu' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Thu">Do</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Fri" name="ACTIVE_DAYS" value="Fri" {% if 'Fri' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Fri">Fr</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Sat" name="ACTIVE_DAYS" value="Sat" {% if 'Sat' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Sat">Sa</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Sun" name="ACTIVE_DAYS" value="Sun" {% if 'Sun' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Sun">So</label>
        </div>
      </div>
    </div>
    <div class="col-12">
      <h6 class="mt-2 mb-1">{{ tr.get("schedule_period", "Schedule Period") if tr else "Schedule Period" }}</h6>
      <details class="text-muted small">
        <summary>{{ tr.get("schedule_period_summary", "How it works") if tr else "How it works" }}</summary>
        <div class="mt-2">
          <div>{{ tr.get("schedule_period_rule_1", "1) Both empty: no date filter") if tr else "1) Both empty: no date filter" }}</div>
          <div>{{ tr.get("schedule_period_rule_2", "2) Start only: active from start date") if tr else "2) Start only: active from start date" }}</div>
          <div>{{ tr.get("schedule_period_rule_3", "3) End only: active until end date (incl.)") if tr else "3) End only: active until end date (incl.)" }}</div>
          <div>{{ tr.get("schedule_period_rule_4", "4) Both set: active within range (incl.)") if tr else "4) Both set: active within range (incl.)" }}</div>
        </div>
      </details>
    </div>
    <!-- hier 2 Datepicker -->
    <div class="col-md-3">
      <label class="form-label">{{ tr.get("date_from", "Start date") if tr else "Start date" }}</label>
      <input type="date" class="form-control date-input-icon" name="DATE_FROM" value="{{ cfg.schedule_start_date or '' }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">{{ tr.get("date_to", "End date") if tr else "End date" }}</label>
      <input type="date" class="form-control date-input-icon" name="DATE_TO" value="{{ cfg.schedule_end_date or '' }}">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-outline-secondary w-100" type="button" id="clear-date-range">
        {{ tr.get("clear_dates", "Clear") if tr else "Clear" }}
      </button>
    </div>
  </div>
  <hr class="mx-auto">
  <!-- Astral -->
  <h5 class="mb-2"><i class="fa-solid fa-sun me-2"></i>{{ tr["astral"] if tr else "Astral (Sun times)" }}</h5>
  <div class="mb-3 form-check form-switch">
    <input class="form-check-input" type="checkbox" id="use-astral" name="USE_ASTRAL" value="true" {% if cfg.use_astral
      %}checked{% endif %}>
    <label class="form-check-label" for="use-astral">{{ tr["use_astral"] if tr else "Use sunrise/sunset" }}</label>
  </div>
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label class="form-label">{{ tr["latitude"] if tr else "Latitude" }}</label>
      <input class="form-control" name="CITY_LAT" value="{{ cfg.city_lat }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ tr["longitude"] if tr else "Longitude" }}</label>
      <input class="form-control" name="CITY_LON" value="{{ cfg.city_lon }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ tr["timezone"] if tr else "Time zone" }}</label>
      <select class="form-select" name="CITY_TZ">
        <option value="UTC" {% if cfg.city_tz=="UTC" %}selected{% endif %}>UTC</option>
        <option value="Europe/Berlin" {% if cfg.city_tz=="Europe/Berlin" %}selected{% endif %}>Europe/Berlin</option>
        <option value="Europe/London" {% if cfg.city_tz=="Europe/London" %}selected{% endif %}>Europe/London</option>
        <option value="Europe/Paris" {% if cfg.city_tz=="Europe/Paris" %}selected{% endif %}>Europe/Paris</option>
        <option value="Europe/Madrid" {% if cfg.city_tz=="Europe/Madrid" %}selected{% endif %}>Europe/Madrid</option>
        <option value="Europe/Rome" {% if cfg.city_tz=="Europe/Rome" %}selected{% endif %}>Europe/Rome</option>
        <option value="Europe/Amsterdam" {% if cfg.city_tz=="Europe/Amsterdam" %}selected{% endif %}>Europe/Amsterdam</option>
        <option value="Europe/Brussels" {% if cfg.city_tz=="Europe/Brussels" %}selected{% endif %}>Europe/Brussels</option>
        <option value="Europe/Vienna" {% if cfg.city_tz=="Europe/Vienna" %}selected{% endif %}>Europe/Vienna</option>
        <option value="Europe/Zurich" {% if cfg.city_tz=="Europe/Zurich" %}selected{% endif %}>Europe/Zurich</option>
        <option value="Europe/Stockholm" {% if cfg.city_tz=="Europe/Stockholm" %}selected{% endif %}>Europe/Stockholm</option>
        <option value="Europe/Copenhagen" {% if cfg.city_tz=="Europe/Copenhagen" %}selected{% endif %}>Europe/Copenhagen</option>
        <option value="Europe/Oslo" {% if cfg.city_tz=="Europe/Oslo" %}selected{% endif %}>Europe/Oslo</option>
        <option value="Europe/Helsinki" {% if cfg.city_tz=="Europe/Helsinki" %}selected{% endif %}>Europe/Helsinki</option>
        <option value="Europe/Warsaw" {% if cfg.city_tz=="Europe/Warsaw" %}selected{% endif %}>Europe/Warsaw</option>
        <option value="Europe/Prague" {% if cfg.city_tz=="Europe/Prague" %}selected{% endif %}>Europe/Prague</option>
        <option value="Europe/Budapest" {% if cfg.city_tz=="Europe/Budapest" %}selected{% endif %}>Europe/Budapest</option>
        <option value="Europe/Athens" {% if cfg.city_tz=="Europe/Athens" %}selected{% endif %}>Europe/Athens</option>
        <option value="Europe/Istanbul" {% if cfg.city_tz=="Europe/Istanbul" %}selected{% endif %}>Europe/Istanbul</option>
        <option value="Europe/Moscow" {% if cfg.city_tz=="Europe/Moscow" %}selected{% endif %}>Europe/Moscow</option>
        <option value="Africa/Johannesburg" {% if cfg.city_tz=="Africa/Johannesburg" %}selected{% endif %}>Africa/Johannesburg</option>
        <option value="Africa/Cairo" {% if cfg.city_tz=="Africa/Cairo" %}selected{% endif %}>Africa/Cairo</option>
        <option value="Africa/Nairobi" {% if cfg.city_tz=="Africa/Nairobi" %}selected{% endif %}>Africa/Nairobi</option>
        <option value="Asia/Jerusalem" {% if cfg.city_tz=="Asia/Jerusalem" %}selected{% endif %}>Asia/Jerusalem</option>
        <option value="Asia/Dubai" {% if cfg.city_tz=="Asia/Dubai" %}selected{% endif %}>Asia/Dubai</option>
        <option value="Asia/Riyadh" {% if cfg.city_tz=="Asia/Riyadh" %}selected{% endif %}>Asia/Riyadh</option>
        <option value="Asia/Tehran" {% if cfg.city_tz=="Asia/Tehran" %}selected{% endif %}>Asia/Tehran</option>
        <option value="Asia/Kolkata" {% if cfg.city_tz=="Asia/Kolkata" %}selected{% endif %}>Asia/Kolkata</option>
        <option value="Asia/Bangkok" {% if cfg.city_tz=="Asia/Bangkok" %}selected{% endif %}>Asia/Bangkok</option>
        <option value="Asia/Singapore" {% if cfg.city_tz=="Asia/Singapore" %}selected{% endif %}>Asia/Singapore</option>
        <option value="Asia/Shanghai" {% if cfg.city_tz=="Asia/Shanghai" %}selected{% endif %}>Asia/Shanghai</option>
        <option value="Asia/Tokyo" {% if cfg.city_tz=="Asia/Tokyo" %}selected{% endif %}>Asia/Tokyo</option>
        <option value="Asia/Seoul" {% if cfg.city_tz=="Asia/Seoul" %}selected{% endif %}>Asia/Seoul</option>
        <option value="Australia/Sydney" {% if cfg.city_tz=="Australia/Sydney" %}selected{% endif %}>Australia/Sydney</option>
        <option value="Australia/Melbourne" {% if cfg.city_tz=="Australia/Melbourne" %}selected{% endif %}>Australia/Melbourne</option>
        <option value="Pacific/Auckland" {% if cfg.city_tz=="Pacific/Auckland" %}selected{% endif %}>Pacific/Auckland</option>
        <option value="America/St_Johns" {% if cfg.city_tz=="America/St_Johns" %}selected{% endif %}>America/St_Johns</option>
        <option value="America/Halifax" {% if cfg.city_tz=="America/Halifax" %}selected{% endif %}>America/Halifax</option>
        <option value="America/New_York" {% if cfg.city_tz=="America/New_York" %}selected{% endif %}>America/New_York</option>
        <option value="America/Chicago" {% if cfg.city_tz=="America/Chicago" %}selected{% endif %}>America/Chicago</option>
        <option value="America/Denver" {% if cfg.city_tz=="America/Denver" %}selected{% endif %}>America/Denver</option>
        <option value="America/Los_Angeles" {% if cfg.city_tz=="America/Los_Angeles" %}selected{% endif %}>America/Los_Angeles</option>
        <option value="America/Phoenix" {% if cfg.city_tz=="America/Phoenix" %}selected{% endif %}>America/Phoenix</option>
        <option value="America/Anchorage" {% if cfg.city_tz=="America/Anchorage" %}selected{% endif %}>America/Anchorage</option>
        <option value="America/Honolulu" {% if cfg.city_tz=="America/Honolulu" %}selected{% endif %}>America/Honolulu</option>
        <option value="America/Mexico_City" {% if cfg.city_tz=="America/Mexico_City" %}selected{% endif %}>America/Mexico_City</option>
        <option value="America/Bogota" {% if cfg.city_tz=="America/Bogota" %}selected{% endif %}>America/Bogota</option>
        <option value="America/Lima" {% if cfg.city_tz=="America/Lima" %}selected{% endif %}>America/Lima</option>
        <option value="America/Sao_Paulo" {% if cfg.city_tz=="America/Sao_Paulo" %}selected{% endif %}>America/Sao_Paulo</option>
        <option value="America/Buenos_Aires" {% if cfg.city_tz=="America/Buenos_Aires" %}selected{% endif %}>America/Buenos_Aires</option>
      </select>
      <div class="form-text">{{ tr.get("timezone_note", "Gilt für aktive Zeiten, Status-Uhr und (optional) Sonnenzeiten.") if tr else "Gilt für aktive Zeiten, Status-Uhr und (optional) Sonnenzeiten." }}</div>
    </div>
  </div>
  <div class="mb-2 d-flex flex-wrap gap-3 align-items-center">
    <button class="btn btn-outline-secondary btn-sm" type="button" id="geo-browser-btn">
      <i class="fa-solid fa-location-crosshairs me-1"></i>{{ tr.get('coords_browser', 'Browserstandort übernehmen') if tr else 'Browserstandort übernehmen' }}
    </button>
    <a href="https://www.latlong.net/convert-address-to-lat-long.html" target="_blank" rel="noopener noreferrer">
      <i class="fa-solid fw-7 fa-location-dot me-1"></i>{{ tr['coords_help'] if tr else 'Get coordinates from address'
      }}
    </a>
  </div>
  <hr class="mx-auto">
  <div class="mt-4 d-flex flex-wrap gap-3 align-items-center justify-content-end">
    <button class="btn btn-success px-4" type="submit"><i class="fa-solid fa-floppy-disk me-2"></i>{{ tr["save"] if tr
      else "Save" }}</button>
  </div>
</form>

<div class="mt-4 pt-3 border-top text-muted small d-flex flex-wrap gap-3 justify-content-between align-items-center">
  <div><a href="https://github.com/der-pw/capturelapse" target="_blank" rel="noopener noreferrer">{{ tr['app_name'] if tr else 'CaptureLapse' }}</a> · {{ app_version }}</div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='js/settings.js') }}?v={{ app_version }}"></script>
{% endblock %}


